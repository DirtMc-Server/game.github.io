<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Space Master â€” Ultimate</title>
<style>
:root{
  --bg1:#020417; --bg2:#000006;
  --neon:#00f0ff; --accent:#8b5cff; --glass: rgba(255,255,255,0.04);
}
*{box-sizing:border-box;font-family:Inter, "Segoe UI", Tahoma, Arial; color:#eafcff}
html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));-webkit-user-select:none;user-select:none}
canvas{display:block;position:fixed; inset:0; z-index:0;}
/* UI */
#overlay {position:fixed;inset:0;z-index:60;display:flex;align-items:center;justify-content:center;pointer-events:auto}
#modeSelect{position:fixed;inset:0;background:linear-gradient(180deg, rgba(0,0,0,0.85), rgba(0,0,0,0.95));display:flex;align-items:center;justify-content:center;flex-direction:column;gap:18px;z-index:120}
.modeBtn{padding:14px 28px;border-radius:12px;border:1px solid rgba(255,255,255,0.06);background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.08));font-size:18px;cursor:pointer;color:#eaffff}
#topBar{position:fixed;left:12px;right:12px;top:10px;display:flex;justify-content:space-between;align-items:center;z-index:70;pointer-events:none}
.title{font-weight:800;font-size:18px;pointer-events:auto}
.topBtns{pointer-events:auto;display:flex;gap:8px}
.btn{padding:8px 12px;border-radius:10px;border:none;cursor:pointer;background:linear-gradient(90deg,var(--neon),var(--accent));color:#021;font-weight:800;box-shadow:0 8px 22px rgba(0,0,0,0.6)}
#bottomHUD{position:fixed;left:12px;right:12px;bottom:12px;z-index:70;display:flex;justify-content:space-between;gap:12px;padding:12px;border-radius:14px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.22));backdrop-filter: blur(6px);border:1px solid rgba(0,255,255,0.04);pointer-events:auto}
.hudItem{display:flex;flex-direction:column;gap:4px}
.hudLabel{font-size:12px;color:rgba(200,240,255,0.8)}
.hudValue{font-weight:800;font-size:18px;color:var(--neon)}
/* joystick */
#joystick{position:fixed;left:50%;transform:translateX(-50%);bottom:120px;width:150px;height:150px;border-radius:50%;background:rgba(255,255,255,0.03);display:none;z-index:80;border:1px solid rgba(255,255,255,0.04);pointer-events:auto;touch-action:none;}
#stick{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:64px;height:64px;border-radius:50%;background:linear-gradient(180deg,#cfd,#909);box-shadow:0 10px 30px rgba(0,0,0,0.6)}
/* upgrade overlay */
#upgradeOverlay{position:fixed;inset:0;background:linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.9));display:none;z-index:110;align-items:center;justify-content:center}
.upgradePanel{width:92%;max-width:1300px;height:88%;background:linear-gradient(180deg, rgba(8,12,20,0.9), rgba(2,4,8,0.98));border-radius:14px;padding:14px;display:flex;gap:12px;box-shadow:0 30px 80px rgba(0,0,0,0.6);border:1px solid rgba(0,255,255,0.04);pointer-events:auto}
.leftCol{width:320px;display:flex;flex-direction:column;gap:12px}
.infoCard{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.12));padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.02)}
.treeWrap{flex:1;position:relative;overflow:hidden;border-radius:10px;background:radial-gradient(ellipse at 30% 10%, rgba(0,255,220,0.02), transparent 6%), radial-gradient(ellipse at 80% 90%, rgba(139,92,255,0.012), transparent 6%);pointer-events:auto}
#treeArea{position:absolute;left:0;top:0;width:2400px;height:1600px;cursor:grab}
.node{position:absolute;width:190px;padding:10px 12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(0,0,0,0.12));border:2px solid rgba(255,255,255,0.04);box-shadow:0 10px 28px rgba(0,0,0,0.6);text-align:center;cursor:pointer;transition:transform .15s,box-shadow .15s,opacity .15s}
.node.locked{opacity:0.26;filter:grayscale(.2)}
.node.unlocked{border-color:var(--neon);box-shadow:0 10px 38px rgba(0,240,255,0.06)}
.node.buyable{animation:pulse 1.2s infinite}
.node .title{font-weight:800;color:#e9ffff;margin-bottom:6px}
.node .sub{font-size:12px;color:rgba(220,255,255,0.7)}
.node .cost{position:absolute;right:8px;top:8px;background:rgba(0,0,0,0.35);padding:4px 8px;border-radius:8px;font-weight:800;font-size:12px;color:#ffd}
.node .lvl{position:absolute;left:8px;top:8px;font-size:12px;color:rgba(200,255,255,0.9)}
.tooltip{position:fixed;z-index:9999;padding:8px 10px;background:rgba(2,6,20,0.9);border-radius:8px;border:1px solid rgba(0,255,255,0.06);display:none;pointer-events:none}

/* responsive */
@media (max-width:800px){
  .leftCol{display:none}
  .upgradePanel{padding:8px}
  #joystick{width:180px;height:180px}
}
</style>
</head>
<body>

<canvas id="bg"></canvas>
<canvas id="game"></canvas>

<div id="modeSelect">
  <div style="text-align:center;color:#dff;font-size:22px;font-weight:800;margin-bottom:6px">Ø§Ø®ØªØ§Ø± Ø¬Ù‡Ø§Ø² Ø§Ù„Ù„Ø¹Ø¨</div>
  <div style="display:flex;gap:12px">
    <button id="btnPC" class="modeBtn">PC â€” Ù…Ø§ÙˆØ³</button>
    <button id="btnMobile" class="modeBtn">Ø¬ÙˆØ§Ù„ â€” Ù„Ù…Ø³</button>
  </div>
  <div style="margin-top:12px;color:rgba(200,255,255,0.7);font-size:12px">ØªÙ‚Ø¯Ø± ØªØºÙŠÙ‘Ø± Ø§Ù„ÙˆØ¶Ø¹ Ø¨Ø¹Ø¯ÙŠÙ† Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø²Ø± "Ø´Ø¬Ø±Ø© Ø§Ù„ØªØ·ÙˆÙŠØ±"</div>
</div>

<div id="topBar">
  <div class="title">ğŸš€ Space Master</div>
  <div class="topBtns">
    <button id="openTree" class="btn">ğŸŒ³ Ø´Ø¬Ø±Ø© Ø§Ù„ØªØ·ÙˆÙŠØ±</button>
    <button id="resetBtn" class="btn" title="Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª">Ø¥Ø¹Ø§Ø¯Ø©</button>
  </div>
</div>

<div id="bottomHUD">
  <div class="hudItem"><div class="hudLabel">â¤ Ø§Ù„ØµØ­Ø©</div><div class="hudValue" id="hpVal">20</div></div>
  <div class="hudItem"><div class="hudLabel">ğŸ’° Ø§Ù„ÙÙ„ÙˆØ³</div><div class="hudValue" id="moneyVal">0</div></div>
  <div class="hudItem"><div class="hudLabel">â­ Ø§Ù„Ù†Ù‚Ø§Ø·</div><div class="hudValue" id="scoreVal">0</div></div>
  <div class="hudItem"><div class="hudLabel">âš”ï¸ Ø¶Ø±Ø±</div><div class="hudValue" id="dmgVal">3</div></div>
</div>

<div id="joystick"><div id="stick"></div></div>

<div id="upgradeOverlay">
  <div class="upgradePanel">
    <div class="leftCol">
      <div class="infoCard">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:800">Ø´Ø¬Ø±Ø© Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª</div>
            <div style="font-size:12px;color:rgba(200,240,255,0.7)">Ø§Ø´ØªØ±Ù Ù„ÙØªØ­ ÙØ±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯Ø© â€” Ø§Ø³Ø­Ø¨ Ø§Ù„Ø´Ø¬Ø±Ø© Ù„ØªØ­Ø±ÙŠÙƒÙ‡Ø§</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:8px">
            <button id="closeTree" class="btn" style="background:linear-gradient(90deg,#fff,#b6f7ff)">Ø±Ø¬ÙˆØ¹</button>
            <button id="resetTree" class="btn" style="background:linear-gradient(90deg,#ff9,#f98)">Ø§Ø¹Ø§Ø¯Ø© Ø§Ù„Ø´Ø¬Ø±Ø©</button>
          </div>
        </div>
      </div>

      <div class="infoCard">
        <div style="font-weight:800">Ø§Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø³ÙÙŠÙ†Ù‡</div>
        <div style="margin-top:6px;font-size:13px;color:rgba(200,240,255,0.8)">
          ğŸ’¥ Ø¶Ø±Ø±: <span id="statDmg">3</span><br>
          â±ï¸ Ø²Ù…Ù† Ø¥Ø·Ù„Ø§Ù‚: <span id="statRate">2000</span>ms<br>
          ğŸš€ Ø¹Ø¯Ø¯ Ø§Ù„ØµÙˆØ§Ø±ÙŠØ®: <span id="statMiss">1</span><br>
          â¤ Ø­Ø¯ ØµØ­Ø©: <span id="statMaxHP">20</span>
        </div>
      </div>

      <div class="infoCard">
        <div style="font-weight:800">Ù†ØµØ§Ø¦Ø­ Ø³Ø±ÙŠØ¹Ø©</div>
        <ul style="margin:8px 0 0 18px;color:rgba(200,240,255,0.85);font-size:13px">
          <li>Ø§Ø¨Ø¯Ø£ Ø¨Ø´Ø±Ø§Ø¡ Ø¬Ø°ÙˆØ± Ø§Ù„Ø´Ø¬Ø±Ø© Ù„ÙØªØ­ Ù…Ø³Ø§Ø±Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©</li>
          <li>ÙƒÙ„Ù…Ø§ ÙƒØ¨Ø±Øª Ø§Ù„ØµØ®ÙˆØ±ØŒ Ø²Ø§Ø¯Øª Ø§Ù„ÙÙ„ÙˆØ³</li>
          <li>Ø¥Ø°Ø§ Ù„Ø¹Ø¨Øª Ø¹Ù„Ù‰ Ø§Ù„Ø¬ÙˆØ§Ù„ØŒ Ø§Ø³Ø­Ø¨ Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ù„ØªØ­Ø±Ùƒ Ø§Ù„Ø³ÙÙŠÙ†Ø©</li>
        </ul>
      </div>

    </div>

    <div class="treeWrap">
      <div id="treeArea"></div>
    </div>

  </div>
</div>

<div id="tooltip" class="tooltip"></div>

<script>
/* ------------------------------- setup canvases ------------------------------- */
const bg = document.getElementById('bg'), game = document.getElementById('game');
const ctxBG = bg.getContext('2d'), ctx = game.getContext('2d');
function resize(){ bg.width = game.width = innerWidth; bg.height = game.height = innerHeight; }
addEventListener('resize', resize); resize();

/* ------------------------------- audio helper ------------------------------- */
const audioCtx = window.AudioContext ? new AudioContext() : null;
function tone(freq,d=0.03,vol=0.04){
  if(!audioCtx) return;
  const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
  o.type='sine'; o.frequency.value = freq; g.gain.value = vol;
  o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime + d);
}

/* ------------------------------- persistent save ------------------------------- */
const SAVE = 'space_master_v2';
let state = { money:0, score:0, upgrades:{}, mode:null };
try{ const s = localStorage.getItem(SAVE); if(s) state = JSON.parse(s);}catch(e){}
function saveState(){ localStorage.setItem(SAVE, JSON.stringify(state)); }

/* ------------------------------- game state ------------------------------- */
let mode = state.mode || null;
const joystick = document.getElementById('joystick'), stick = document.getElementById('stick');
let stickCenter = null, stickPos = {x:0,y:0}, stickDragging=false;

/* player */
const player = { x: innerWidth/2, y: innerHeight/2, r:20, health:20, maxHealth:20, damage:3, fireRate:1800, missiles:1, missileSpeed:6, speed:3, shield:0, regen:0 };

/* entities */
let rocks = [], missiles = [], particles = [];

/* spawn */
function spawnRock(edge){
  const r = Math.random()*38 + 12;
  let x,y;
  const side = edge ?? Math.floor(Math.random()*4);
  if(side===0){ x = -r-10; y = Math.random()*innerHeight; }
  else if(side===1){ x = innerWidth + r+10; y = Math.random()*innerHeight; }
  else if(side===2){ x = Math.random()*innerWidth; y = -r-10; }
  else { x = Math.random()*innerWidth; y = innerHeight + r + 10; }
  rocks.push({ x, y, r, hp: Math.ceil(r/3)*6, baseSpeed: 0.5 + Math.random()*0.9, value: Math.ceil(r/3)*6});
}
for(let i=0;i<10;i++) spawnRock();

/* ------------------------------- upgrades tree definitions ------------------------------- */
const UP = {
  damage: {name:'Ø¬Ø°Ø±: Ø¶Ø±Ø±', desc:'ÙŠØ²ÙŠØ¯ Ø¶Ø±Ø± Ø§Ù„ØµÙˆØ§Ø±ÙŠØ®', cost:60, max:6, deps:[], apply:lvl=> player.damage = 3 + lvl*2},
  fireRate: {name:'Ø¬Ø°Ø±: Ø³Ø±Ø¹Ø© Ø§Ø·Ù„Ø§Ù‚', desc:'ÙŠÙ‚Ù„Ù„ Ø²Ù…Ù† Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚', cost:80, max:6, deps:['damage'], apply:lvl=> player.fireRate = Math.max(250, 1800 - lvl*220)},
  missiles: {name:'Ø¬Ø°Ø±: ØµÙˆØ§Ø±ÙŠØ®', desc:'Ø²ÙŠØ§Ø¯Ø© Ø¹Ø¯Ø¯ Ø§Ù„ØµÙˆØ§Ø±ÙŠØ®', cost:90, max:5, deps:['damage'], apply:lvl=> player.missiles = 1 + lvl},
  missileSpeed: {name:'Ø³Ø±Ø¹Ø© Ø§Ù„ØµÙˆØ§Ø±ÙŠØ®', desc:'ØªØ²ÙŠØ¯ Ø³Ø±Ø¹Ø© Ø§Ù„ØµÙˆØ§Ø±ÙŠØ®', cost:80, max:5, deps:['missiles'], apply:lvl=> player.missileSpeed = 6 + lvl*2},
  explosion: {name:'Ø§Ù†ÙØ¬Ø§Ø±', desc:'ØµÙˆØ§Ø±ÙŠØ® ØªØ³Ø¨Ø¨ Ø§Ù†ÙØ¬Ø§Ø± ØµØºÙŠØ±', cost:140, max:3, deps:['missileSpeed'], apply:lvl=> player.explosion = lvl},
  money: {name:'Ø°Ù‡Ø¨', desc:'Ø²ÙŠØ§Ø¯Ø© Ù…ÙƒØ§ÙØ¢Øª Ø§Ù„ØªØ¯Ù…ÙŠØ±', cost:120, max:5, deps:['missiles'], apply:lvl=> player.moneyMul = 1 + lvl*0.18},
  hpMax: {name:'Ù‚Ù„Ø¨ Ø§Ù‚ÙˆÙ‰', desc:'Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„ØµØ­Ø©', cost:120, max:5, deps:['fireRate'], apply:lvl=> { player.maxHealth = 20 + lvl*6; if(player.health>player.maxHealth) player.health = player.maxHealth } },
  regen: {name:'ØªØ¬Ø¯Ø¯', desc:'Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ØµØ­Ø© Ø¨Ù…Ø±ÙˆØ± Ø§Ù„ÙˆÙ‚Øª', cost:160, max:3, deps:['hpMax'], apply:lvl=> player.regen = lvl},
  rockDensity: {name:'Ø²Ø®Ù… Ø§Ù„ØµØ®ÙˆØ±', desc:'ÙŠØ²ÙŠØ¯ Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¸Ù‡ÙˆØ±', cost:110, max:5, deps:['fireRate'], apply:lvl=> game.spawnInterval = Math.max(300, game.baseSpawn - lvl*100)},
  rockSpeed: {name:'Ø³Ø±Ø¹Ø© Ø§Ù„ØµØ®ÙˆØ±', desc:'ÙŠØ²ÙŠØ¯ Ø³Ø±Ø¹Ø© Ø§Ù„ØµØ®ÙˆØ±', cost:110, max:5, deps:['rockDensity'], apply:lvl=> game.rockBase = 0.5 + lvl*0.2},
  homing: {name:'ØªØªØ¨Ø¹', desc:'ØªØ­Ø³Ù† ØªØªØ¨Ø¹ Ø§Ù„ØµÙˆØ§Ø±ÙŠØ®', cost:130, max:3, deps:['missiles'], apply:lvl=> player.homing = lvl},
  shield: {name:'Ø¯Ø±Ø¹', desc:'Ø¯Ø±Ø¹ ÙŠÙ…ØªØµ Ø¶Ø±Ø± Ù…Ø¤Ù‚Øª', cost:190, max:3, deps:['hpMax'], apply:lvl=> player.shieldMax = lvl*8},
  split: {name:'ØªØ´Ø¸ÙŠ', desc:'ØªØµÙ†Ø¹ Ø´Ø¸Ø§ÙŠØ§ Ø¹Ù†Ø¯ Ø§Ù„Ø§ØµØ§Ø¨Ø©', cost:170, max:3, deps:['explosion'], apply:lvl=> player.split = lvl},
  speed: {name:'Ø³Ø±Ø¹Ø©', desc:'ØªØ²ÙŠØ¯ Ø³Ø±Ø¹Ø© Ø§Ù„Ø­Ø±ÙƒØ©', cost:100, max:4, deps:[], apply:lvl=> player.speed = 3 + lvl*1.0}
};
/* initialize saved upgrades */
if(!state.upgrades) state.upgrades = {};
for(const k in UP) if(state.upgrades[k]===undefined) state.upgrades[k] = 0;

/* apply upgrades */
function applyAllUpgrades(){
  // reset base
  player.damage = 3; player.fireRate = 1800; player.missiles = 1; player.missileSpeed = 6; player.moneyMul = 1; player.regen = 0; player.shieldMax = 0; player.explosion = 0; player.homing=0; player.split=0; player.speed=3; player.maxHealth=20;
  for(const id in UP){
    const lvl = state.upgrades[id] || 0;
    if(typeof UP[id].apply === 'function') UP[id].apply(lvl);
  }
  if(!player.health) player.health = player.maxHealth;
}
applyAllUpgrades();

/* ------------------------------- game variables ------------------------------- */
const game = { paused:false, baseSpawn:1200, spawnInterval:1200, rockBase:0.5, lastSpawn:performance.now(), lastFire:performance.now(), passiveTick:performance.now() };

/* ------------------------------- input handling ------------------------------- */
let mouse = {x:player.x, y:player.y};
addEventListener('mousemove', e=>{ if(mode==='pc') { mouse.x = e.clientX; mouse.y = e.clientY; } });

/* joystick handlers (mobile) */
let activeTouchId = null;
function startStick(e){
  stickDragging = true;
  joystick.style.display = 'block';
}
function stopStick(){
  stickDragging = false; stick.style.transform = ''; stickPos = {x:0,y:0};
}
function moveStick(dx,dy){
  const max = 60;
  const mag = Math.hypot(dx,dy);
  const clx = (mag>max) ? dx * max/mag : dx;
  const cly = (mag>max) ? dy * max/mag : dy;
  stick.style.transform = `translate(${clx}px, ${cly}px)`;
  stickPos = { x: clx / max, y: cly / max };
}

/* touch events for joystick */
game.addEventListener('touchstart', ev=>{
  if(mode!=='mobile') return;
  const t = ev.touches[0];
  activeTouchId = t.identifier;
  const sx = t.clientX, sy = t.clientY;
  // place joystick center near bottom if not visible
  const j = document.getElementById('joystick');
  const rect = j.getBoundingClientRect();
  // center at bottom middle by default; we'll set relative movement
  stick.style.transform = 'translate(0,0)';
  stickPos = {x:0,y:0};
});
game.addEventListener('touchmove', ev=>{
  if(mode!=='mobile') return;
  for(const t of ev.touches){
    if(t.identifier === activeTouchId){
      const dx = t.clientX - innerWidth/2;
      const dy = t.clientY - (innerHeight - 120);
      moveStick(dx,dy);
    }
  }
});
game.addEventListener('touchend', ev=>{
  activeTouchId = null; stick.style.transform='translate(0,0)'; stickPos = {x:0,y:0};
});

/* keyboard fallback */
const keys = {};
addEventListener('keydown', e=>{ keys[e.key.toLowerCase()] = true; if(e.key.toLowerCase()==='u') toggleTree(); });
addEventListener('keyup', e=> keys[e.key.toLowerCase()] = false);

/* ------------------------------- firing logic ------------------------------- */
function autoFire(now){
  if(now - game.lastFire < (player.fireRate || 1800)) return;
  game.lastFire = now;
  const count = player.missiles || 1;
  for(let i=0;i<count;i++){
    if(rocks.length===0) continue;
    let target = rocks.reduce((a,b)=> (Math.hypot(a.x-player.x,a.y-player.y) < Math.hypot(b.x-player.x,b.y-player.y) ? a : b));
    if(Math.random() < 0.18 && rocks.length>2) target = rocks[Math.floor(Math.random()*rocks.length)];
    const angle = Math.atan2((target.y-player.y)+(Math.random()-0.5)*30, (target.x-player.x)+(Math.random()-0.5)*30);
    const vx = Math.cos(angle)*(player.missileSpeed||6), vy = Math.sin(angle)*(player.missileSpeed||6);
    missiles.push({ x:player.x + Math.cos(angle)*player.r, y:player.y + Math.sin(angle)*player.r, vx, vy, target });
  }
  tone(760,0.02,0.02);
}

/* ------------------------------- game loop & physics ------------------------------- */
function updatePlayer(dt){
  if(mode==='pc'){
    const dx = mouse.x - player.x, dy = mouse.y - player.y;
    player.x += dx * 0.06 * (dt/16); player.y += dy * 0.06 * (dt/16);
  } else if(mode==='mobile'){
    player.x += (stickPos.x || 0) * player.speed * 4 * (dt/16);
    player.y += (stickPos.y || 0) * player.speed * 4 * (dt/16);
  } else {
    // keyboard fallback
    let ax=0, ay=0; if(keys['w']) ay-=1; if(keys['s']) ay+=1; if(keys['a']) ax-=1; if(keys['d']) ax+=1;
    const mag = Math.hypot(ax,ay) || 1;
    player.x += (ax/mag) * player.speed * 2 * (dt/16); player.y += (ay/mag) * player.speed * 2 * (dt/16);
  }
  player.x = Math.max(0, Math.min(innerWidth, player.x));
  player.y = Math.max(0, Math.min(innerHeight, player.y));
}

function destroyRock(i){
  const r = rocks[i];
  if(!r) return;
  const reward = Math.ceil(r.value * (player.moneyMul || 1));
  state.money = (state.money || 0) + reward; state.score = (state.score || 0) + Math.ceil(r.r/2);
  for(let p=0;p<20;p++) particles.push({x:r.x,y:r.y,vx:(Math.random()-0.5)*6,vy:(Math.random()-0.5)*6,life:24,col:'#ffd4a3'});
  if(r.r > 22){
    const parts = Math.min(3, Math.floor(r.r/14));
    for(let k=0;k<parts;k++) rocks.push({ x: r.x + (Math.random()-0.5)*20, y: r.y + (Math.random()-0.5)*20, r: r.r*(0.45+Math.random()*0.2), hp: Math.ceil(r.r*0.5), baseSpeed: 0.3 + Math.random()*0.6, value: Math.ceil(r.r*0.4/3)*6 });
  }
  rocks.splice(i,1);
  setTimeout(()=> spawnRock(Math.floor(Math.random()*4)), 600 + Math.random()*900);
  saveState(); tone(260,0.02,0.06);
}

function spawnIfNeeded(now){
  if(now - game.lastSpawn > game.spawnInterval){ game.lastSpawn = now; spawnRock(Math.floor(Math.random()*4)); }
}

function step(now, last, dt){
  if(!game.paused){
    updatePlayer(dt);
    // rocks
    for(let i=rocks.length-1;i>=0;i--){
      const r = rocks[i];
      const dx = player.x - r.x, dy = player.y - r.y; const d = Math.hypot(dx,dy) || 1;
      const speed = (game.rockBase + r.r/110) * (1 + ((state.upgrades && state.upgrades.rockSpeed)||0)*0.05);
      r.x += (dx/d) * speed * (dt/16); r.y += (dy/d) * speed * (dt/16);
      // wrap
      if(r.x < -r.r - 30) r.x = innerWidth + r.r + 10;
      if(r.x > innerWidth + r.r + 30) r.x = -r.r - 10;
      if(r.y < -r.r - 30) r.y = innerHeight + r.r + 10;
      if(r.y > innerHeight + r.r + 30) r.y = -r.r - 10;
      // collision with player
      const dist = Math.hypot(r.x-player.x, r.y-player.y);
      if(dist < r.r + player.r){
        let dmg = 2;
        if(player.shield && player.shield > 0){
          const take = Math.min(player.shield, dmg); player.shield -= take; dmg -= take;
        }
        player.health -= dmg;
        r.x += (r.x - player.x)/dist * 18; r.y += (r.y - player.y)/dist * 18;
        for(let k=0;k<6;k++) particles.push({x:player.x+(Math.random()-0.5)*24,y:player.y+(Math.random()-0.5)*24,vx:(Math.random()-0.5)*3,vy:(Math.random()-0.5)*3,life:12,col:'#ff9d9d'});
        tone(220,0.02,0.03);
        if(Math.random() < 0.09) destroyRock(i);
      }
      if(r.hp <= 0) destroyRock(i);
    }

    // missiles
    for(let i=missiles.length-1;i>=0;i--){
      const m = missiles[i];
      if(m.target && rocks.includes(m.target)){
        const tx = m.target.x, ty = m.target.y;
        const dx = tx - m.x, dy = ty - m.y; const d = Math.hypot(dx,dy) || 1;
        const homing = 0.9 + ((player.homing||0)*0.07);
        m.vx = (m.vx * (1-homing)) + (dx/d) * player.missileSpeed * homing;
        m.vy = (m.vy * (1-homing)) + (dy/d) * player.missileSpeed * homing;
      }
      m.x += m.vx * (dt/16); m.y += m.vy * (dt/16);
      // wrap
      if(m.x < -30) m.x = innerWidth + 30;
      if(m.x > innerWidth + 30) m.x = -30;
      if(m.y < -30) m.y = innerHeight + 30;
      if(m.y > innerHeight + 30) m.y = -30;
      // collision
      for(let j=rocks.length-1;j>=0;j--){
        const r = rocks[j];
        if(Math.hypot(r.x - m.x, r.y - m.y) < r.r + 6){
          const crit = Math.random() < (player.crit||0);
          const baseD = player.damage;
          const dmg = baseD * (crit ? 2 : 1);
          r.hp -= dmg;
          for(let p=0;p<10;p++) particles.push({x:m.x,y:m.y,vx:(Math.random()-0.5)*4,vy:(Math.random()-0.5)*4,life:18,col: crit ? '#ffd46a' : '#ffb2b2'});
          tone(540,0.02,0.03);
          if(player.explosion){
            const rad = 26 * player.explosion;
            for(let rr=rocks.length-1; rr>=0; rr--){
              if(rr!==j){
                const dd = Math.hypot(rocks[rr].x - m.x, rocks[rr].y - m.y);
                if(dd < rad) rocks[rr].hp -= Math.ceil(dmg*0.5);
              }
            }
          }
          missiles.splice(i,1);
          break;
        }
      }
    }

    // particles
    for(let i=particles.length-1;i>=0;i--){
      const p = particles[i];
      p.x += p.vx * (dt/16); p.y += p.vy * (dt/16); p.vx *= 0.98; p.vy *= 0.98; p.life--;
      if(p.life<=0) particles.splice(i,1);
    }

    // passive regen
    if(player.regen && now - game.passiveTick > 2000){ player.health = Math.min(player.maxHealth, player.health + player.regen); game.passiveTick = now; }

    // spawn & fire
    spawnIfNeeded(now); autoFire(now);

    // death
    if(player.health <= 0){
      game.paused = true; openTree();
    }
  }
}

/* ------------------------------- rendering (improved visuals) ------------------------------- */
function renderBG(now){
  ctxBG.clearRect(0,0,bg.width,bg.height);
  const grd = ctxBG.createLinearGradient(0,0,bg.width,bg.height);
  grd.addColorStop(0,'#001428'); grd.addColorStop(0.6,'#020213'); grd.addColorStop(1,'#000008');
  ctxBG.fillStyle = grd; ctxBG.fillRect(0,0,bg.width,bg.height);
  // nebula blobs
  const t = now * 0.00004;
  for(let i=0;i<5;i++){
    const rx = (Math.sin(t*(i+1)+i)+1)/2 * bg.width;
    const ry = (Math.cos(t*(i+2)+i)+1)/2 * bg.height;
    const rad = Math.min(bg.width,bg.height) * (0.12 + i*0.04);
    const g = ctxBG.createRadialGradient(rx,ry,rad*0.1, rx,ry,rad);
    g.addColorStop(0, `rgba(139,92,255,${0.02 + i*0.01})`);
    g.addColorStop(1, 'rgba(0,0,0,0)');
    ctxBG.fillStyle = g; ctxBG.fillRect(rx-rad,ry-rad,rad*2,rad*2);
  }
  // stars
  for(let i=0;i<200;i++){
    const x = (i*37) % bg.width;
    const y = (i*97 + (now*0.01)) % bg.height;
    ctxBG.fillStyle = 'rgba(255,255,255,' + (0.3 + (Math.sin((now*0.002)+i)*0.2)) + ')';
    ctxBG.fillRect(x, y, 1.5, 1.5);
  }
}

function drawShip(p){
  ctx.save(); ctx.translate(p.x, p.y);
  const angle = 0;
  // glow
  ctx.beginPath(); ctx.fillStyle = 'rgba(0,240,255,0.06)'; ctx.arc(0,0,p.r+22,0,Math.PI*2); ctx.fill();
  // main body (3D-ish)
  ctx.beginPath(); ctx.moveTo(p.r,0); ctx.lineTo(-p.r*0.7, -p.r*0.9); ctx.lineTo(-p.r*0.7, p.r*0.9); ctx.closePath();
  const g = ctx.createLinearGradient(-p.r, -p.r, p.r, p.r);
  g.addColorStop(0,'#bff'); g.addColorStop(1,'#6ee');
  ctx.fillStyle = g; ctx.fill(); ctx.strokeStyle = 'rgba(0,0,0,0.18)'; ctx.lineWidth = 1; ctx.stroke();
  // cockpit glass
  ctx.beginPath(); ctx.fillStyle = '#012028'; ctx.arc(-p.r*0.25,0,p.r*0.42,0,Math.PI*2); ctx.fill();
  // engine thrusters
  for(let i=0;i<2;i++){
    const ex = p.r*0.4; const ey = (i===0? -p.r*0.5 : p.r*0.5);
    ctx.beginPath();
    const grad = ctx.createLinearGradient(ex+6,ey, ex-14,ey);
    grad.addColorStop(0,'rgba(255,200,90,0.7)'); grad.addColorStop(1,'rgba(255,90,50,0.1)');
    ctx.fillStyle = grad; ctx.ellipse(-p.r*0.9, ey, 6, 10, 0, 0, Math.PI*2); ctx.fill();
  }
  // shield ring
  if(p.shield && p.shield > 0){
    ctx.beginPath(); ctx.strokeStyle = 'rgba(120,240,255,0.5)'; ctx.lineWidth = 4; ctx.arc(0,0,p.r+12,0,Math.PI*2); ctx.stroke();
  }
  ctx.restore();
}

/* draw rocks with pseudo 3D shading */
function drawRock(r){
  // core
  const grad = ctx.createRadialGradient(r.x - r.r*0.3, r.y - r.r*0.3, r.r*0.1, r.x, r.y, r.r);
  grad.addColorStop(0, '#ddd'); grad.addColorStop(0.6, '#9a9a9a'); grad.addColorStop(1, '#454545');
  ctx.fillStyle = grad; ctx.beginPath(); ctx.arc(r.x, r.y, r.r, 0, Math.PI*2); ctx.fill();
  // some craters â€” randomized by position hash
  const c = Math.floor((r.x + r.y) % 4) + 2;
  for(let i=0;i<c;i++){
    const ang = (i/c) * Math.PI*2 + (r.x*0.0005);
    const cx = r.x + Math.cos(ang)*(r.r*0.35);
    const cy = r.y + Math.sin(ang)*(r.r*0.35);
    ctx.beginPath(); ctx.fillStyle = 'rgba(0,0,0,0.18)'; ctx.ellipse(cx,cy, r.r*0.14, r.r*0.08, 0,0,Math.PI*2); ctx.fill();
  }
  // HP bar
  ctx.fillStyle = 'rgba(0,0,0,0.45)'; ctx.fillRect(r.x - r.r, r.y - r.r - 8, r.r*2, 6);
  const maxHp = Math.ceil(r.r/3)*6;
  ctx.fillStyle = '#ff6b6b'; ctx.fillRect(r.x - r.r, r.y - r.r - 8, (r.hp / maxHp) * r.r*2, 6);
}

/* render loop */
let last = performance.now();
function loop(now){
  const dt = now - last;
  renderBG(now);
  step(now, last, dt);
  // main render
  ctx.clearRect(0,0,game.width,game.height);
  // draw rocks
  for(const r of rocks) drawRock(r);
  // draw missiles and trails
  for(const m of missiles){
    ctx.beginPath(); ctx.fillStyle = 'rgba(255,150,110,0.95)'; ctx.arc(m.x, m.y, 4, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle = 'rgba(255,200,130,0.2)'; ctx.fillRect(m.x-2, m.y-10, 4, 8);
  }
  // draw particles
  for(const p of particles) { ctx.fillStyle = p.col; ctx.fillRect(p.x, p.y, 2,2); }
  // draw player
  drawShip(player);
  // update HUD
  document.getElementById('hpVal').textContent = Math.max(0, Math.floor(player.health));
  document.getElementById('moneyVal').textContent = Math.floor(state.money || 0);
  document.getElementById('scoreVal').textContent = Math.floor(state.score || 0);
  document.getElementById('dmgVal').textContent = player.damage;
  last = now;
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* ------------------------------- spawn loop & auto-fire interval ------------------------------- */
setInterval(()=>{ if(!game.paused) spawnRock(Math.floor(Math.random()*4)); }, 1100);
setInterval(()=>{ if(!game.paused) saveState(); }, 6000);

/* ------------------------------- UI functions: open/close tree ------------------------------- */
const openTreeBtn = document.getElementById('openTree'), upgradeOverlay = document.getElementById('upgradeOverlay'), closeTree = document.getElementById('closeTree'), resetTree = document.getElementById('resetTree'), treeArea = document.getElementById('treeArea'), tooltip = document.getElementById('tooltip');

openTreeBtn.addEventListener('click', ()=>{ openTree(); });
closeTree.addEventListener('click', ()=>{ closeTree(); });
resetTree.addEventListener('click', ()=>{ if(confirm('Ø§Ø¹Ø¯ ØªØ¹ÙŠÙŠÙ† ÙƒÙ„ Ø§Ù„ØªØ·ÙˆÙŠØ±Ø§ØªØŸ')){ for(const k in state.upgrades) state.upgrades[k]=0; state.money=0; state.score=0; applyAllUpgrades(); saveState(); renderTree(); } });

function openTree(){ upgradeOverlay.style.display='flex'; game.paused = true; renderTree(); }
function closeTree(){ upgradeOverlay.style.display='none'; game.paused = false; saveState(); }

/* ------------------------------- tree rendering & interaction (deep tree) ------------------------------- */
const layout = [
  {id:'damage', x:160, y:90},{id:'fireRate', x:420, y:200},{id:'missiles', x:720, y:200},
  {id:'missileSpeed', x:720, y:340},{id:'explosion', x:980, y:440},{id:'split', x:1180, y:560},
  {id:'money', x:520, y:360},{id:'hpMax', x:200, y:360},{id:'regen', x:200, y:520},
  {id:'rockDensity', x:640, y:520},{id:'rockSpeed', x:860, y:640},{id:'homing', x:960, y:320},
  {id:'shield', x:40, y:640},{id:'speed', x:40, y:840}
];

function isUnlockedNode(id){
  const def = UP[id]; if(!def) return false;
  if(def.deps.length === 0) return true;
  return def.deps.some(d => (state.upgrades[d] && state.upgrades[d] > 0));
}

function renderTree(){
  treeArea.innerHTML = '';
  // svg for lines
  const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.setAttribute('width','100%'); svg.setAttribute('height','100%'); svg.style.position='absolute'; svg.style.left='0'; svg.style.top='0';
  treeArea.appendChild(svg);
  const cont = document.createElement('div'); cont.style.position='absolute'; cont.style.left='0'; cont.style.top='0'; cont.style.width='2400px'; cont.style.height='1600px';
  treeArea.appendChild(cont);
  const pos = {};
  layout.forEach(n=> pos[n.id] = {x: n.x + 95, y: n.y + 30});
  // lines
  layout.forEach(node=>{
    const def = UP[node.id]; if(!def) return;
    def.deps.forEach(dep=>{
      if(!pos[dep]) return;
      const p1 = pos[dep], p2 = pos[node.id]; const mx = (p1.x + p2.x)/2;
      const d = `M ${p1.x} ${p1.y} C ${mx} ${p1.y-70}, ${mx} ${p2.y+70}, ${p2.x} ${p2.y}`;
      const path = document.createElementNS('http://www.w3.org/2000/svg','path'); path.setAttribute('d',d);
      const color = (state.upgrades[dep] && state.upgrades[dep]>0) ? 'rgba(0,240,255,0.95)' : 'rgba(255,255,255,0.06)';
      path.setAttribute('stroke', color); path.setAttribute('stroke-width','3'); path.setAttribute('fill','none'); svg.appendChild(path);
    });
  });
  // nodes
  layout.forEach(node=>{
    const def = UP[node.id]; if(!def) return;
    const el = document.createElement('div'); el.className='node';
    el.style.left = node.x + 'px'; el.style.top = node.y + 'px';
    const lvl = state.upgrades[node.id] || 0;
    el.innerHTML = `<div class="lvl">Lv.${lvl}/${def.max}</div><div class="title">${def.name}</div><div class="sub">${def.desc}</div><div class="cost">${def.cost}ğŸ’ </div>`;
    if(lvl >= def.max) el.classList.add('locked');
    else if(isUnlockedNode(node.id) && (state.money || 0) >= def.cost) el.classList.add('buyable');
    else if(isUnlockedNode(node.id)) el.classList.add('unlocked');
    else el.classList.add('locked');
    el.addEventListener('mouseenter', ev=>{ tooltip.style.left = (ev.clientX+12)+'px'; tooltip.style.top = (ev.clientY+12)+'px'; tooltip.style.display='block'; tooltip.innerHTML = `<b>${def.name}</b><br>${def.desc}<br>ØªÙƒÙ„ÙØ©: ${def.cost} â€¢ Ø§Ù„Ø­Ø¯: ${def.max} â€¢ Ø§Ù„Ù…Ø³ØªÙˆÙ‰: ${lvl}`; });
    el.addEventListener('mousemove', ev=>{ tooltip.style.left = (ev.clientX+12)+'px'; tooltip.style.top = (ev.clientY+12)+'px'; });
    el.addEventListener('mouseleave', ()=>{ tooltip.style.display='none'; });
    el.addEventListener('click', ()=>{
      if(state.upgrades[node.id] >= def.max){ alert('ÙˆØµÙ„Øª Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰'); return; }
      if(!isUnlockedNode(node.id)){ alert('Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù‚Ø¯Ø© Ù…Ù‚ÙÙ„Ø©'); return; }
      if((state.money || 0) < def.cost){ alert('ÙÙ„ÙˆØ³Ùƒ Ù‚Ù„ÙŠÙ„Ø©'); return; }
      state.money -= def.cost; state.upgrades[node.id] = (state.upgrades[node.id]||0) + 1;
      UP[node.id].cost = Math.ceil(def.cost * 1.25);
      applyAllUpgrades(); saveState(); renderTree();
      tone(980,0.04,0.06);
    });
    cont.appendChild(el);
  });

  // allow dragging the treeArea by mouse
  let mouseDown = false, sx=0, sy=0, ox=0, oy=0;
  treeArea.style.left = Math.max(0, (innerWidth - 1200)/2) + 'px';
  treeArea.style.top = Math.max(0, (innerHeight - 800)/2) + 'px';
  treeArea.onmousedown = e=>{ mouseDown=true; sx = e.clientX; sy = e.clientY; ox = parseInt(treeArea.style.left||0); oy = parseInt(treeArea.style.top||0); treeArea.style.cursor='grabbing'; }
  window.addEventListener('mousemove', e=>{ if(!mouseDown) return; const dx = e.clientX - sx; const dy = e.clientY - sy; treeArea.style.left = (ox + dx) + 'px'; treeArea.style.top = (oy + dy) + 'px'; });
  window.addEventListener('mouseup', ()=>{ mouseDown=false; treeArea.style.cursor='grab'; });
}

/* ------------------------------- UI: mode selection buttons working robustly ------------------------------- */
document.getElementById('btnPC').addEventListener('click', ()=>{ chooseMode('pc'); });
document.getElementById('btnMobile').addEventListener('click', ()=>{ chooseMode('mobile'); });
function chooseMode(m){
  mode = m; state.mode = m; saveState();
  document.getElementById('modeSelect').style.display = 'none';
  if(m === 'mobile'){ document.getElementById('joystick').style.display = 'block'; } else { document.getElementById('joystick').style.display = 'none'; }
  applyAllUpgrades(); player.health = Math.min(player.health || player.maxHealth, player.maxHealth);
}

/* ------------------------------- open debug / reset ------------------------------- */
document.getElementById('resetBtn').addEventListener('click', ()=>{
  if(confirm('Ø§Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ù‡ Ø§Ù„Ø§ØµÙ„ÙŠØ© (Ø³ÙŠØ­Ø°Ù Ø§Ù„Ø­ÙØ¸)ØŸ')){
    localStorage.removeItem(SAVE); location.reload();
  }
});

/* ------------------------------- ensure mode visible if saved ------------------------------- */
if(state.mode){ chooseMode(state.mode); } else { /* show selector */ }

/* final: save every X seconds */
setInterval(()=> saveState(), 5000);

/* keyboard: toggle tree U */
addEventListener('keydown', e=>{ if(e.key.toLowerCase()==='u') { if(document.getElementById('upgradeOverlay').style.display==='flex') closeTree(); else openTree(); } });

</script>
</body>
</html>
